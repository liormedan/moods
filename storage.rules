rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // ========================================
    // 🔒 אבטחה מקסימלית לקבצים
    // ========================================
    
    // Users can only access their own profile images
    match /users/{userId}/profile/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Users can only access their own journal attachments
    match /users/{userId}/journal/{entryId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Users can only access their own mood entry attachments
    match /users/{userId}/mood/{entryId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Users can only access their own goal attachments
    match /users/{userId}/goals/{goalId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Users can only access their own breathing exercise files
    match /users/{userId}/breathing/{sessionId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Users can only access their own progress report files
    match /users/{userId}/reports/{reportId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Users can only access their own data export files
    match /users/{userId}/exports/{exportId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Support group files - only members can access
    match /support_groups/{groupId}/files/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Therapist profile images - public read, owner write
    match /therapists/{therapistId}/profile/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == therapistId;
      allow delete: if request.auth != null && request.auth.uid == therapistId;
    }

    // ========================================
    // 🚫 BLOCK ALL OTHER ACCESS
    // ========================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
